#!/bin/bash

# WG-Easy Telegram Bot - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð¾Ñ‚Ð°

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}  WG-Easy Telegram Bot Installer${NC}"
    echo -e "${BLUE}================================${NC}"
    echo
}

print_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [ -f /etc/debian_version ]; then
            OS="debian"
        elif [ -f /etc/redhat-release ]; then
            OS="redhat"
        elif [ -f /etc/arch-release ]; then
            OS="arch"
        else
            OS="linux"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
    else
        OS="unknown"
    fi
    print_message "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° ÐžÐ¡: $OS"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
install_dependencies() {
    print_step "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    case $OS in
        "debian")
            print_message "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ Debian/Ubuntu..."
            apt-get update
            
            print_message "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
            apt-get install -y curl wget git python3 python3-pip python3-venv docker.io docker-compose-plugin
            
            # Ð—Ð°Ð¿ÑƒÑÐº Docker
            systemctl start docker
            systemctl enable docker
            ;;
        "redhat")
            print_message "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ CentOS/RHEL..."
            yum update -y
            
            print_message "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
            yum install -y curl wget git python3 python3-pip docker docker-compose-plugin
            
            # Ð—Ð°Ð¿ÑƒÑÐº Docker
            systemctl start docker
            systemctl enable docker
            ;;
        "arch")
            print_message "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð´Ð»Ñ Arch Linux..."
            pacman -Syu --noconfirm
            
            print_message "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
            pacman -S --noconfirm curl wget git python python-pip docker docker-compose
            
            # Ð—Ð°Ð¿ÑƒÑÐº Docker
            systemctl start docker
            systemctl enable docker
            ;;
        "macos")
            print_message "Ð”Ð»Ñ macOS ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker Desktop Ñ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°"
            print_message "https://www.docker.com/products/docker-desktop/"
            ;;
        *)
            print_error "ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°!"
            exit 1
            ;;
    esac
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
check_dependencies() {
    print_step "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python
    if ! command -v python3 &> /dev/null; then
        print_error "Python 3 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
        install_dependencies
    else
        print_message "Python 3 Ð½Ð°Ð¹Ð´ÐµÐ½ âœ“"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Docker
    if ! command -v docker &> /dev/null; then
        print_error "Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
        install_dependencies
    else
        print_message "Docker Ð½Ð°Ð¹Ð´ÐµÐ½ âœ“"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Docker Compose
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        print_error "Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
        install_dependencies
    else
        print_message "Docker Compose Ð½Ð°Ð¹Ð´ÐµÐ½ âœ“"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Docker
    if ! docker ps &> /dev/null; then
        print_warning "ÐÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Docker!"
        print_message "Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ docker..."
        usermod -aG docker $USER
        print_warning "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿ÐµÑ€ÐµÐ·Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¸Ð»Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: newgrp docker"
        print_message "Ð—Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº ÑÐ½Ð¾Ð²Ð°"
        exit 1
    fi
    
    print_message "Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ âœ“"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ WG-Easy
check_wg_easy() {
    print_step "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° WG-Easy..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ wg-easy
    if ! docker ps --format "{{.Names}}" | grep -q "wg-easy"; then
        print_error "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ wg-easy Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
        echo
        print_message "Ð”Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ WG-Easy Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
        echo "docker run -d \\"
        echo "  --name=wg-easy \\"
        echo "  -e WG_HOST=\$(curl -s ifconfig.me) \\"
        echo "  -e PASSWORD=\$(openssl rand -base64 32) \\"
        echo "  -v \$(pwd)/wg-easy:/etc/wireguard \\"
        echo "  -p 51820:51820/udp \\"
        echo "  -p 51821:51821/tcp \\"
        echo "  --cap-add=NET_ADMIN \\"
        echo "  --cap-add=SYS_MODULE \\"
        echo "  --sysctl=\"net.ipv4.conf.all.src_valid_mark=1\" \\"
        echo "  --sysctl=\"net.ipv4.ip_forward=1\" \\"
        echo "  --restart unless-stopped \\"
        echo "  weejewel/wg-easy"
        echo
        read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð±Ð¾Ñ‚Ð°? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_message "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°."
            exit 0
        fi
    else
        print_message "WG-Easy Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ âœ“"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°
    WG_EASY_URL="http://localhost:51821"
    if curl -s --connect-timeout 5 "$WG_EASY_URL" > /dev/null; then
        print_message "Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ WG-Easy Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ âœ“"
    else
        print_warning "Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ WG-Easy Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ $WG_EASY_URL"
        echo
        read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ URL Ð´Ð»Ñ WG-Easy (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: http://IP:51821): " WG_EASY_URL
        if [[ -z "$WG_EASY_URL" ]]; then
            WG_EASY_URL="http://localhost:51821"
        fi
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
get_user_settings() {
    print_step "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±Ð¾Ñ‚Ð°..."
    echo
    
    # Telegram Bot Token
    while true; do
        echo -e "${CYAN}Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð±Ð¾Ñ‚Ð°:${NC}"
        echo "1. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ @BotFather Ð² Telegram"
        echo "2. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /newbot"
        echo "3. Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼"
        echo
        read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Telegram Ð±Ð¾Ñ‚Ð°: " TELEGRAM_TOKEN
        if [[ -n "$TELEGRAM_TOKEN" ]]; then
            break
        else
            print_error "Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        fi
    done
    
    # Admin ID
    while true; do
        echo -e "${CYAN}Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Telegram ID:${NC}"
        echo "1. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ @userinfobot Ð² Telegram"
        echo "2. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð»ÑŽÐ±Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"
        echo "3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð°Ñˆ ID"
        echo
        read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Telegram ID: " ADMIN_ID
        if [[ "$ADMIN_ID" =~ ^[0-9]+$ ]]; then
            break
        else
            print_error "ID Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼!"
        fi
    done
    
    # WG-Easy URL
    read -p "URL WG-Easy ÑÐµÑ€Ð²ÐµÑ€Ð° [$WG_EASY_URL]: " USER_WG_EASY_URL
    if [[ -n "$USER_WG_EASY_URL" ]]; then
        WG_EASY_URL="$USER_WG_EASY_URL"
    fi
    
    # Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    read -p "Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ… [10]: " MONITOR_INTERVAL
    if [[ -z "$MONITOR_INTERVAL" ]]; then
        MONITOR_INTERVAL="10"
    fi
    
    echo
    print_message "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ âœ“"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ .env Ñ„Ð°Ð¹Ð»Ð°
create_env_file() {
    print_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    
    cat > .env << EOF
# WG-Easy Telegram Bot Configuration
TELEGRAM_TOKEN=$TELEGRAM_TOKEN
ADMIN_ID=$ADMIN_ID
WG_EASY_URL=$WG_EASY_URL
MONITOR_INTERVAL=$MONITOR_INTERVAL

# Docker Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
COMPOSE_PROJECT_NAME=wg-easy-tg
EOF
    
    print_message "Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½ âœ“"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±Ð¾Ñ‚Ð°
test_bot() {
    print_step "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð±Ð¾Ñ‚Ð°..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½
    if curl -s "https://api.telegram.org/bot$TELEGRAM_TOKEN/getMe" | grep -q '"ok":true'; then
        print_message "Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ âœ“"
    else
        print_error "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°!"
        exit 1
    fi
    
    # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    print_message "ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ..."
    curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
        -d "chat_id=$ADMIN_ID" \
        -d "text=ðŸ¤– WG-Easy Bot ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!" \
        -d "parse_mode=Markdown" > /dev/null
    
    if [ $? -eq 0 ]; then
        print_message "Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ âœ“"
    else
        print_warning "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°
start_bot() {
    print_step "Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
    
    # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
    docker-compose down 2>/dev/null || true
    
    # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
    docker-compose up -d --build
    
    if [ $? -eq 0 ]; then
        print_message "Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ âœ“"
    else
        print_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°!"
        exit 1
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
create_management_scripts() {
    print_step "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
    cat > start_bot.sh << 'EOF'
#!/bin/bash
echo "Ð—Ð°Ð¿ÑƒÑÐº WG-Easy Telegram Bot..."
docker-compose up -d
echo "Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
    cat > stop_bot.sh << 'EOF'
#!/bin/bash
echo "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° WG-Easy Telegram Bot..."
docker-compose down
echo "Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð²
    cat > logs_bot.sh << 'EOF'
#!/bin/bash
echo "ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² WG-Easy Telegram Bot..."
docker-compose logs -f wg-easy-tg-bot
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°
    cat > restart_bot.sh << 'EOF'
#!/bin/bash
echo "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº WG-Easy Telegram Bot..."
docker-compose restart wg-easy-tg-bot
echo "Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
EOF
    
    # Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼Ð¸
    chmod +x start_bot.sh stop_bot.sh logs_bot.sh restart_bot.sh
    
    print_message "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ âœ“"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾ÐºÐ°Ð·Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
show_info() {
    print_step "Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ"
    echo
    echo -e "${GREEN}âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!${NC}"
    echo
    echo -e "${CYAN}Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±Ð¾Ñ‚Ð¾Ð¼:${NC}"
    echo "  ./start_bot.sh    - Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°"
    echo "  ./stop_bot.sh     - ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð¾Ñ‚Ð°"
    echo "  ./restart_bot.sh  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°"
    echo "  ./logs_bot.sh     - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
    echo
    echo -e "${CYAN}ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð°:${NC}"
    echo "  /start      - Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ"
    echo "  /status     - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°"
    echo "  /speed      - Ð¢ÐµÑÑ‚ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸"
    echo "  /restart    - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº WG-Easy"
    echo "  /monitoring - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð¾Ð¼"
    echo
    echo -e "${CYAN}ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:${NC}"
    echo "  Ð¤Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸: .env"
    echo "  Ð›Ð¾Ð³Ð¸: docker-compose logs -f wg-easy-tg-bot"
    echo
    echo -e "${YELLOW}Ð’Ð°Ð¶Ð½Ð¾:${NC}"
    echo "  - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ WG-Easy Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
    echo "  - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð² Ñ„Ð°Ð¹Ð»Ðµ .env"
    echo "  - ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
    echo
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    print_header
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° root
    if [[ $EUID -ne 0 ]]; then
        print_error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root!"
        print_message "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: sudo $0"
        exit 1
    fi
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐžÐ¡
    detect_os
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    check_dependencies
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ WG-Easy
    check_wg_easy
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
    get_user_settings
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    create_env_file
    
    # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¾Ñ‚Ð°
    test_bot
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
    start_bot
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
    create_management_scripts
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
    show_info
}

# Ð—Ð°Ð¿ÑƒÑÐº
main "$@"
